kind: AIchorManifest
spec:
 types:
  job:
   ntasks: 1
   nodes: 1
   cpus_per_task: 1
   memory_per_cpu: 1G
   standard_input: "/dev/null"
   standard_output: "/home/ec2-user/outputs/output-%j.out"
   standard_error: "/home/ec2-user/outputs/output_error-%j.out"
   environment:
    PATH: "/bin:/usr/bin/:/usr/local/bin/:/opt/slurm/bin"
    LD_LIBRARY_PATH: "/lib/:/lib64/:/usr/local/lib"
 command: |
  #!/bin/bash
  #printenv
  echo expid:exp123,jobid:$SLURM_JOB_ID,node:$SLURMD_NODENAME
  curl -X POST -k -H 'content-type: application/json' -d '{"status": "'"$SLURM_JOB_ID"' STARTED"}' 'https://2wrdeowf5zsted45pq5o6zloii0dkmbf.lambda-url.eu-west-3.on.aws/'
  sudo -u slurm touch /mnt/shared/strigger
  sudo chmod +x /mnt/shared/strigger
  sudo -u slurm bash -c 'cat <<EOF > /mnt/shared/strigger
  curl -X POST -k -H "content-type: application/json" -d '{"message": "$SLURM_JOB_ID FINISHED"} 'https://2wrdeowf5zsted45pq5o6zloii0dkmbf.lambda-url.eu-west-3.on.aws/
  EOF'
  #sudo chown slurm:slurm /mnt/shared/strigger_$SLURM_JOB_ID
  #sudo chmod +x /mnt/shared/strigger_$SLURM_JOB_ID
  sudo -u slurm bash -c '/opt/slurm/bin/strigger --set -j '"$SLURM_JOB_ID"' --fini --program=/mnt/shared/strigger --flags=PERM'
  echo "-------STRIGGER COMPLETED--------"
  #python3 -u main.py --operator=tf --sleep=300 --tb-write=True
